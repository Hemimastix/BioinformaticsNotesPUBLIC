# Working with SVG files

Many phylogenetics packages do not save a background, which can be annoying when working in Inkscape and lead to strange raster exports. To insert white background, after `<svg style="...>` block at the top add:

```xml
<rect width="100%" height="100%" fill="white"/>
```

Source: [Default background color of SVG root element - Stack Overflow](https://stackoverflow.com/questions/11293026/default-background-color-of-svg-root-element)



## Parsing XML files using minidom in Python

(I'm writing this out because I completely forgot everything I learned 2 years ago when I last worked with SVG files directly. Maybe I can go 3 years this way.)

SVG files are a subtype of XML.

Here is an example using a script for batch renaming leaf taxon names in a tree using a tsv file. Note: this did what I needed it to do at the time, but this may not be a _correct_ way to work with XML files.

```python
import xml.dom.minidom
import xml.dom.xmlbuilder
# additional imports
import sys, csv, re
```

Lazy loading of files from arguments:

```python
svg_infile = sys.argv[1]
renaming_file = sys.argv[2]
doc = xml.dom.minidom.parse(svg_infile)

use_italics = True # for italicising scientific names

#load dictionary
Fullnames = {}
with open(renaming_file, "r") as f:
    for l in csv.reader(f, delimiter='\t'):
        print(f"{len(l)} columns detected.")
        Fullnames[l[0]] = l[1:]


```

Now `doc` stores the parsed SVG file. The `Fullnames` block generates a dictionary from the tsv file, which is formatted as:

```
taxon_name_exactly_as_in_tree    Species name (or something to italicise)    The rest (strain names, accession numbers, etc)
```

Now for the XML part. XML is a tree, but file content rather than taxa. The file contains a hierarchy of nodes with associated attributes, many of them having to do with drawing the tree topology using coordinates and their transformations. You usually don't need to worry about that, so here we'll focus on text only. 

Open an SVG file in your favourite text editor, ideally with syntax highlighting. Get acqainted with it. Note that different software may structure this file differently. FigTree's output starts out with the header followed by the tree outline paths. 

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE svg PUBLIC '-//W3C//DTD SVG 1.0//EN'
          'http://www.w3.org/TR/2001/REC-SVG-20010904/DTD/svg10.dtd'>
<svg style="fill-opacity:1; color-rendering:auto; color-interpolation:auto; text-rendering:auto; stroke:black; stroke-linecap:square; stroke-miterlimit:10; shape-rendering:auto; stroke-opacity:1; fill:black; stroke-dasharray:none; font-weight:normal; stroke-width:1; font-family:&apos;Dialog&apos;; font-style:normal; stroke-linejoin:miter; font-size:12; stroke-dashoffset:0; image-rendering:auto;" xmlns="http://www.w3.org/2000/svg" width="1263.0" viewBox="0 0 1263.0 1610.0" xmlns:xlink="http://www.w3.org/1999/xlink" height="1610.0"
><!--Generated by the Batik Graphics2D SVG Generator--><defs id="genericDefs"
  />
```

### Path

```xml
      /><path d="M21.8124 1114.6744 L21.3314 1114.6744 L21.3314 1045.662" style="fill:none; stroke-width:2;"
      /><path d="M61.5656 1197.4894 L35.5264 1197.4894 L35.5264 1205.6686" style="fill:none; stroke-width:2;"
      /><path d="M665.9773 363.2054 L559.8619 363.2054 L559.8619 355.0261" style="fill:none; stroke-width:2;"
      /><path d="M79.4662 637.7695 L59.9994 637.7695 L59.9994 689.6327" style="fill:none; stroke-width:2;">
```

[Paths - SVG: Scalable Vector Graphics | MDN](https://developer.mozilla.org/en-US/docs/Web/SVG/Tutorial/Paths)

A `path` is the most general vector shape (vs. `rect` or `line` or `circle`), its shape defined by a single parameter `d`, which is a list of coordinates and commands. `M` and `L` are examples of commands. `M 10 10` moves cursor to coordinates (10,10) and awaits for the next command. Uppercase letters specify absolute coordinates, lowercase are relative. `M` vs. `m` (e.g. `m 10 10` will move the cursor 10px down and 10px to the right of the previous location). `L` draws a line to the next x, y coordinate, `l` draws a line by x, y units. `Z` draws a line directly to the first coordinate, completing the shape.

`d="M61.5656 1197.4894 L35.5264 1197.4894 L35.5264 1205.6686"` Starts at (61.5656, 1197.4894), and draws a line to (35.5264, 1197.4894) and then to (35.5264, 1205.6686). From coordinates, it's evident that the first line segment is horizontal to the left (decreasing number) and the next is vertical going downwards (increasing). In other words, it includes a branch length and a connector to the corresponding parent node in this case.

Another example:

`d="M32.631 19.6767 L379.9544 11.4974 L379.9544 27.8559 Z"`

This path starts at (32.631, 19.6767), draws a line to (379.9544 11.4974), then to (379.9544, 27.8559), and finally draws a line to the starting coordinate. What shape does this produce?

If you imagined a very narrow isosceles triangle, eg. representing a collapsed clade, that was correct! 

Luckily, the rendering software does all these calculations for us, so we don't need to know how exactly the trees are drawn, unless there is a problem. Nevertheless, it is useful to have a general idea for possible debugging purposes later.

You can explore and edit individual XML elements using `Edit` > `XML editor` in InkScape. 

### Text and the rest of the file

The scalebar is apparently coded here:

```xml
<line y2="1580" style="fill:none;" x1="360.3241" x2="502.1082" y1="1580"
      /><text x="423.3109" xml:space="preserve" y="1595" style="stroke:none;"
      >0.3</text>
```

Next come the `text` elements:

```xml
<text x="0" y="12" transform="matrix(1,0,0,1,53.0262,1533.5181)" style="font-size:12; stroke:none; stroke-width:2;" xml:space="preserve"
      >Pavlomulina_LC599498.1</text
    ></g
    ><g transform="matrix(1,0,0,1,400.2881,525.2905)" style="text-rendering:optimizeLegibility; stroke-width:2; font-family:&apos;Lucida Sans&apos;; stroke-linecap:round; stroke-linejoin:round;"
    ><text x="0" xml:space="preserve" y="12" style="stroke:none;"
      >NY0171</text
    >
```

From what I can tell, this renderer places the first text element inside the group (`<g>`) with the tree paths, and the rest are each in their own groups. So, the context of a regular text element looks like this:

```xml
    <g transform="matrix(1,0,0,1,400.2881,525.2905)" style="text-rendering:optimizeLegibility; stroke-width:2; font-family:&apos;Lucida Sans&apos;; stroke-linecap:round; stroke-linejoin:round;"
    ><text x="0" xml:space="preserve" y="12" style="stroke:none;"
      >NY0171</text>
</g>
```

The transformation matrix (i.e. where the text goes; see: [transform - SVG: Scalable Vector Graphics | MDN](https://developer.mozilla.org/en-US/docs/Web/SVG/Attribute/transform) -- if you're like me, this is where you regret not having taken any linear algebra...) and styling correspond to the `g` element containing the text, which includes properties like fonts and sizes and -- this is useful -- things like `font-style-italic` and `fill:red`.  The `text` element contains its own attributes, as well as the text item as a _child node_. This becomes relevant when working with `minidom`.

In this example, the leaf taxon names are then followed by support values. Those look like this:

```xml
<g transform="matrix(1,0,0,1,51.1013,734.4901)" style="font-size:10; stroke-linecap:round; text-rendering:optimizeLegibility; font-family:&apos;Lucida Sans&apos;; stroke-linejoin:round; stroke-width:2;"
    ><text x="-3.1616" xml:space="preserve" y="0.498" style="stroke:none;"
      >4</text
    ></g
    ><g transform="matrix(1,0,0,1,253.4857,96.8796)" style="font-size:10; stroke-linecap:round; text-rendering:optimizeLegibility; font-family:&apos;Lucida Sans&apos;; stroke-linejoin:round; stroke-width:2;"
    ><text x="-6.3232" xml:space="preserve" y="0.498" style="stroke:none;"
      >36</text
    ></g
    >
```



### An aside: Output from Ete3

For comparison, Ete3's tree vector graphic output, generated via PyQt4, is structured quite differently.

```xml
 <g fill="none" stroke="#808080" stroke-opacity="1" 
 stroke-dasharray="3,6" stroke-dashoffset="0" stroke-width="3" 
 stroke-linecap="butt" stroke-linejoin="bevel" 
 transform="matrix(0.210934,0,0,0.210934,197.696,0.210934)" 
 font-family="Sans Serif" font-size="9pt" font-weight="400" 
 font-style="normal"  > 
 <polyline fill="none" vector-effect="none" points="59.6574,25.25 57.6574,25.25 " /> </g> 
      <g fill="none" stroke="#797b7d" stroke-opacity="1" stroke-width="3" stroke-linecap="butt" stroke-linejoin="bevel" transform="matrix(0.210934,0,0,0.210934,197.696,0.210934)" 
 font-family="Sans Serif" font-size="9pt" font-weight="400" 
 font-style="normal"  > 
 <polyline fill="none" vector-effect="none" points="0,25.25 59.6574,25.25 " /> </g>                        
 <g fill="none" stroke="#797b7d" stroke-opacity="1" 
 stroke-width="2" stroke-linecap="butt" stroke-linejoin="bevel" 
 transform="matrix(0.210934,0,0,0.210934,210.28,0.210934)" 
 font-family="Sans Serif" font-size="9pt" font-weight="400" 
 font-style="normal"  > 
 <polyline fill="none" vector-effect="none" points="0,12.5 128.887,12.5 " /> </g>          
 <g fill="none" stroke="#000000" stroke-opacity="1" stroke-width="1" 
 stroke-linecap="square" stroke-linejoin="bevel" 
 transform="matrix(0.210934,0,0,0.210934,237.467,0.316401)" 
 font-family="Arial" font-size="10pt" font-weight="400" 
 font-style="normal"  > 
 <text fill="#000000" fill-opacity="1" stroke="none" xml:space="preserve"
  x="0" y="19" font-family="Arial" font-size="10pt" font-weight="400" 
 font-style="normal"   >Leishmania_JN003595.1|JQ648649.1.4864</text> </g>
 <g fill="none" stroke="#797b7d" stroke-opacity="1" stroke-width="2" 
 stroke-linecap="butt" stroke-linejoin="bevel" 
 transform="matrix(0.210934,0,0,0.210934,210.28,5.48428)" 
 font-family="Sans Serif" font-size="9pt" font-weight="400" 
 font-style="normal"  > 
 <polyline fill="none" vector-effect="none" points="0,13 45.0696,13 " />
  </g>         
  <g fill="none" stroke="#000000" stroke-opacity="1" stroke-width="1" 
 stroke-linecap="square" stroke-linejoin="bevel" transform="matrix(0.210934,0,0,0.210934,219.787,5.69521)" 
 font-family="Arial" font-size="10pt" font-weight="400" font-style="normal"  > 
 <text fill="#000000" fill-opacity="1" stroke="none" xml:space="preserve" x="0" y="19" font-family="Arial" font-size="10pt" font-weight="400" font-style="normal"  
  >Trypanosoma_SM12676.1|X14553.1</text> </g>      <g fill="none" stroke="#000000" 
 stroke-opacity="1" stroke-width="1" stroke-linecap="square" 
 stroke-linejoin="bevel" transform="matrix(0.210934,0,0,0.210934,289.817,4.53507)" 
 font-family="Arial" font-size="12pt" font-weight="400" 
 font-style="italic"  > 
 <text fill="#000000" fill-opacity="1" stroke="none" xml:space="preserve" x="0" y="22" font-family="Arial" font-size="12pt" font-weight="400" font-style="italic"   
 >Trypanosoma</text> </g>       
 
```

Ignoring the denser collection of attributes, the tree here is drawn using `polyline` and those elements alternate with the text elements corresponding to them. The support values are at the end of the file written as such:

```xml
<g fill="none" stroke="#000000" stroke-opacity="1" stroke-width="1" 
stroke-linecap="square" stroke-linejoin="bevel" transform="matrix(0.210934,0,0,0.210934,101.034,784.462)" 
font-family="Myriad pro" font-size="10pt" font-weight="400" 
font-style="normal"  > 
<text fill="#000000" fill-opacity="1" stroke="none" xml:space="preserve" 
x="0" y="19" font-family="Myriad pro" font-size="10pt" font-weight="400" 
font-style="normal"   >99</text> </g>          
<g fill="none" stroke="#000000" stroke-opacity="1" stroke-width="1" 
stroke-linecap="square" stroke-linejoin="bevel" transform="matrix(0.210934,0,0,0.210934,105.552,777.923)" 
font-family="Myriad pro" font-size="11pt" font-weight="700" font-style="normal"  > 
<text fill="#000000" fill-opacity="1" stroke="none" xml:space="preserve" x="0" y="21" 
font-family="Myriad pro" font-size="11pt" font-weight="700" 
font-style="normal"   >100</text> </g>          
<g fill="none" stroke="#000000" stroke-opacity="1" stroke-width="1" 
stroke-linecap="square" stroke-linejoin="bevel" transform="matrix(0.210934,0,0,0.210934,115.235,772.123)" 
font-family="Myriad pro" font-size="10pt" font-weight="400" 
font-style="normal"  > 
<text fill="#000000" fill-opacity="1" stroke="none" xml:space="preserve" 
x="0" y="19" font-family="Myriad pro" font-size="10pt" font-weight="400" 
font-style="normal"   >87</text> </g>  
```

### Working with XML tree structures

[xml.dom.minidom — Minimal DOM implementation &#8212; Python 3.12.2 documentation](https://docs.python.org/3/library/xml.dom.minidom.html)

[xml.dom — The Document Object Model API &#8212; Python 3.12.2 documentation](https://docs.python.org/3/library/xml.dom.html#objects-in-the-dom)

I use iPython in parallel with the script to explore and test the XML structure. You can avoid for loops by picking random array indices (see below) and checking if they contain the element you're interested in by checking the outputs of `attributes.items()`, `firstChild.nodeValue`, `parentNode.nodeName`, `parentNode.attributes.items()` etc

In order to perform a search and replace function on text[^1], we need to look through all the elements with the `text` tag. We can use the `getElementsByTagName()` command to extract an array of text elements and iterate over it:

```python
for i, g in enumerate(doc.getElementsByTagName("text")):
    if g.childNodes[0] != []:
```

If the first child node is blank, we skip it. (Note: inspect which child node text is stored at with output from other software; this might vary in strange ways)

Now for the simple search and replace:

```python
 if g.childNodes[0].nodeValue in Fullnames:
            # print(g.childNodes[0].nodeValue)
            new_text_array = Fullnames[g.childNodes[0].nodeValue]
```

This finds the corresponding entry in the Fullnames dictionary with the expanded names and miscellaneous other text. Now, my script also italicises scientific names, in black, and renders the accession numbers, strain codes, etc in grey. This pre-emptively sets the value in grey:

```python
            if use_italics:
                g.setAttribute('style', f"{g.getAttribute('style')};fill:grey")
```

A useful feature for next runs would be to colour all the taxon text something offensively garish and then change to black or grey as the the text replacement occurs, to draw attention to taxa missing in the tsv file.



```python
            else:
                new_text_node = doc.createTextNode(new_text_array[0])
            g.childNodes[0] = new_text_node
```

Here, the new text array 





```python
            if len(new_text_array) > 1 and use_italics:

                # formatted_text = "<tspan style="+'"fill:green;font-style:italic"'+">"+new_text_array[0]+"</tspan>"
                style = '"fill:black; font-style:italic"'
                formatted_text = f"<tspan style={style}>{new_text_array[0]}</tspan>"
                if "sp." in new_text_array[1].split(" ")[0]:
                    if len(new_text_array[1].split(' ')) > 1:
                        new_text_array_str = " ".join(new_text_array[1].split(' ')[1:])
                        text_w_sp = f"<tspan style='fill:black'>{new_text_array[1].split(' ')[0]}</tspan> {new_text_array_str}"
                        print(text_w_sp)
                    else:
                        text_w_sp = f"<tspan style='fill:black'>{new_text_array[1].split(' ')[0]}</tspan>"
                    new_text = formatted_text + " " + text_w_sp
                else:
                    new_text = formatted_text + " " + " ".join(new_text_array[1:])
                new_text_node = doc.createCDATASection(new_text)
```

The new text 

















Here we extract numeric text items that correspond to bootstrap support values. In my sample files, the x value of leaf text elements was 0 (this will not work with Ete3 output), so I select the elements that have non-0 x values:

```python
        if g.childNodes[0].nodeValue.isnumeric() and g.getAttribute('x') != 0:  # leaf labels have x val 0 for text; node labels do not
            if int(g.childNodes[0].nodeValue) <= 50:  # TODO: make compatible with posterior probabilities ie <1
                g.childNodes[0].nodeValue = ""  # delete value # note: ideally should probably actually remove node
```

The node value is simply set to nothing; although it would probably be more correct to delete the node altogether.



### The `<tspan>` element

[&lt;tspan&gt; - SVG: Scalable Vector Graphics | MDN](https://developer.mozilla.org/en-US/docs/Web/SVG/Element/tspan)





















[^1]:
    Why not search and replace the whole file directly? 
    
    Well, there's a chance you may have an unfortunately-named taxon name that clashes with the XML file structure...that would end badly. This way ensures only the text is searched and modified. Furthermore, if we'd like the, for example, remove support values under 50, we'd like to do that without accidentally deleting any length or coordinate value under 50.


